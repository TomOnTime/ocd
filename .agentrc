ssh_agent_file=$HOME/.ssh/agent.$HOSTNAME

get_idents () { ssh-add -l 2>/dev/null |awk '{print $3}' |sort |xargs; }

identities="$(get_idents)"

if [ -z "$identities" ]; then
  [ -f $ssh_agent_file ] && . $ssh_agent_file >/dev/null
  # If ssh-agent socket and PID don't exist, start a new agent.
  if ! ([ -S "$SSH_AUTH_SOCK" ] && kill -0 "$SSH_AGENT_PID"); then
    echo "Starting new ssh-agent"
    ssh-agent > $ssh_agent_file
    . $ssh_agent_file >/dev/null
    ssh-add
  fi
fi

[ -z "$identities" ] && identities="$(get_idents)"
echo "Identities: $identities"

unset get_idents
