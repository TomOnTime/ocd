# ocd-restore:        pull from git master and copy files to homedir
# ocd-backup:         push local changes to master
# ocd-status:         check if OK or Behind
# ocd-missing-debs:   compare system against ~/.favdebs and report missing
# ocd-extra-debs:     compare system against ~/.favdebs and report extras


ocd-restore () {
  IGNORE_RE="^\./(README|\.git/)"

  : ${OCDDIRS:="$HOME/.ocd"}

  for ocddir in $OCDDIRS; do
    if [ ! -d "$ocddir" ]; then
      echo "$ocddir: doesn't exist!" && continue
    fi
    pushd $ocddir >/dev/null
    echo "$ocddir: git-pull:"
    git pull || {
      echo "error: couldn't git-pull; check status in $ocddir" 1>&2
      popd >/dev/null && return 1
    }

    files=$(find . -type f | egrep -v  "$IGNORE_RE")
    dirs=$(find . -type d | egrep -v  "$IGNORE_RE")

    for dir in $dirs; do
      mkdir -p $HOME/$dir
    done

    echo -n "$ocddir: restoring"
    for file in $files; do
      echo -n .
      src="$file"
      dst="$HOME/$file"
      if [ -f $dst ]; then
        rm -f $dst
      fi
      ln $file $dst
    done
    echo

    # Some changes require cleanup that OCD won't handle; e.g., if you rename
    # a file the old file will remain. Housekeeping commands that need to be
    # run may be put in $ocddir/.ocd_cleanup; they run only once.
    if ! cmp $HOME/.ocd_cleanup{,_ran} &>/dev/null; then
      echo -e "$ocddir: running $HOME/.ocd_cleanup:"
      $HOME/.ocd_cleanup && cp $HOME/.ocd_cleanup{,_ran}
    fi
    popd >/dev/null
  done
}

ocd-backup () {
  pushd $HOME/.ocd >/dev/null
  echo -e "git status in `pwd`:\n"
  git status
  if ! git status | grep -q "working directory clean"; then
    echo -e "\n\ngit diff in `pwd`:\n"
    git diff
    echo -n "Commit and push now? (yes/no): "
    read ANS
    if [ $ANS == "yes" ];then
      git commit -a && git push
    fi
  fi
  popd >/dev/null
}

ocd-status () {
  pushd $HOME/.ocd >/dev/null
  git remote update &>/dev/null
  if git status -uno | grep -q behind; then
    echo "Behind"
    popd >/dev/null && return 1
  else
    echo "OK"
    popd >/dev/null && return 0
  fi
  echo "Error"
  popd >/dev/null && return 1
}

ocd-missing-debs () {
  dpkg --get-selections | grep '\sinstall$' | awk '{print $1}' | sort \
      | comm -13 - <(egrep -v '(^-|^ *#)' $HOME/.favdebs \
      | sed 's/ *#.*$//' |sort)
}

ocd-extra-debs () {
  dpkg --get-selections | grep '\sinstall$' | awk '{print $1}' | sort \
      | comm -12 - <(grep -v '^ *#' $HOME/.favdebs | grep '^-' | cut -b2- \
      | sed 's/ *#.*$//' |sort)
}
